USE CANTONORTE
SET DATEFORMAT DMY                                                 

SELECT DISTINCT
    
    LAN.CODIGO,
    LAN.NUMERODOCUMENTO NUMERODOC,	
	UPPER(LAN.PAGREC) PAGREC,
	LAN.STATUS,
    
    ISNULL(CAST(TPG.CODIGO AS VARCHAR(5)) + ' - '
        + TPG.DESCRICAO, 'NÃO INFORMADO') AS TIPOPAG,
		
	ISNULL(CAST(TPD.CODIGO AS VARCHAR(10)) + ' - ' 
        + TPD.DESCRICAO, 'NÃO INFORMADO') AS TIPODOC,

	ISNULL(CAST(EVF.CODIGO AS VARCHAR(10)) + ' - ' 
        + EVF.DESCRICAO, 'NÃO INFORMADO') AS EVENTOFINANCEIRO,

	ISNULL(MOV.IDMOV, 'LAN. D. FINAN') AS IDMOV,

	ISNULL(TMV.CODTIPOMOV + ' - ' 
        + UPPER(TMV.DESCRICAO), 'LAN. D. FINAN') AS TIPOMOV,
 
	UPPER(LTRIM(CLI.RAZAO)) +' / '+ 
        CASE WHEN CLI.PESFISOUJUR LIKE '%FÍSICA%' THEN 
            'CPF: ' + CLI.CGCCFO
		ELSE 'CNPJ: ' + CLI.CNPJ END AS CLIFORN,
	
	ISNULL(CAST(GCC.CODIGO AS VARCHAR(10)) + ' - ' 
        + UPPER(GCC.ABREVIATURA) + ' - ' 
        + UPPER(GCC.NOME), 'NÃO INFORMADO') AS CENTROCUSTO,
	
	LAN.DATAGERACAO AS DATAGERACAO,
	LAN.DATAVENCIMENTO AS DATAVENCIMENTO,
	PAG.DATA AS DATAPAGAMENTO,		
		
	ISNULL(LAN.VALORORIGINAL, 0) AS VALORORIGINAL,
	ISNULL(LAN.ACRESCIMO, 0) AS VALORACRESCIMO,
	ISNULL(LAN.DESCONTO, 0) AS VALORDESCONTO,	
	
	CASE WHEN TMV.USA_RATEIO_CCUSTO = 1 THEN -- AND LAN.CENTROCUSTO IS NULL THEN
		ISNULL(MVR.PERCENTUAL * LAN.VALORORIGINAL / 100, 0)
	ELSE ISNULL(LAN.VALORORIGINAL, 0) END AS VALORFINAL,
	
	CASE WHEN TMV.USA_RATEIO_CCUSTO = 1 THEN -- AND LAN.CENTROCUSTO IS NULL THEN
		ISNULL((AGB.VALOR) * MVR.PERCENTUAL / 100, 0)
	    ELSE ISNULL((AGB.VALOR), 0) END AS VALORPAGO

FROM LANCAMENTOS LAN

	LEFT JOIN CLIFORN CLI 
		ON CLI.CODIGO = LAN.CODFORNECEDOR
	
	LEFT JOIN MOVIMENTACOES MOV 
		ON MOV.CODIGO = LAN.CODMOV

	LEFT JOIN MOVIMENTACOES_RATEIO MVR
		ON MVR.CODIGO_MOVIMENTACOES = LAN.CODMOV

	INNER JOIN GCENTROCUSTO GCC
		ON GCC.CODIGO = LAN.CENTROCUSTO
		OR GCC.CODIGO = MOV.CODCENTROCUSTO
		OR GCC.CODIGO = MVR.CODIGO_CENTROCUSTO	

	LEFT JOIN TIPODOC TPD 
		ON TPD.CODIGO = LAN.CODTIPODOC

	LEFT JOIN I_EVENTOFINANCEIRO EVF
		ON EVF.CODIGO = LAN.EVENTOFINANCEIRO	

	LEFT JOIN TIPOMOVIMENTO TMV 
		ON TMV.CODIGO = MOV.CODIGO_TIPOMOVIMENTO	

	LEFT JOIN AGRUPADORBAIXAS AGB
		ON AGB.CODLANCAMENTO = LAN.CODIGO

	LEFT JOIN PAGAMENTOS PAG
		ON PAG.CODIGO = AGB.CODPAGAMENTO

	LEFT JOIN TIPOPAGAMENTO TPG
		ON TPG.CODIGO = PAG.CODTIPOPGTO 
		OR TPG.CODIGO = LAN.CODIGO_TIPOPAGAMENTO

WHERE LAN.STATUS NOT IN ('QUITADO POR ACORDO', 'CANCELADO')